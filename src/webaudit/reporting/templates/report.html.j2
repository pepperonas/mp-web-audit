<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web-Audit Report – {{ report.target_url }}</title>
    <style>{{ css }}</style>
</head>
<body>
<div class="container">

    {# ── Header ── #}
    <div class="header">
        <h1>Web-Audit Report</h1>
        <div class="meta">
            Ziel: <strong>{{ report.target_url }}</strong><br>
            Zeitpunkt: {{ report.zeitstempel.strftime('%d.%m.%Y %H:%M:%S') }}<br>
            Dauer: {{ "%.1f"|format(report.dauer) }}s
            {% if report.autorisierung %}
            <br>Autorisierung bestaetigt: {{ report.autorisierung.zeitstempel.strftime('%d.%m.%Y %H:%M:%S') }}
            {% endif %}
        </div>
    </div>

    {# ── Scores ── #}
    {% if report.scores %}
    <h2>Bewertung</h2>
    <div class="scores">
        {% if 'Gesamt' in report.scores %}
        {% set gs = report.scores['Gesamt'] %}
        <div class="score-card gesamt">
            <div class="score-label">Gesamt-Score</div>
            <div class="score-value {{ score_color_class(gs) }}">{{ "%.0f"|format(gs) }}</div>
            <div class="score-bar"><div class="score-bar-fill {{ bar_color_class(gs) }}" style="width:{{ gs }}%"></div></div>
        </div>
        {% endif %}
        {% for cat, score in report.scores.items() if cat != 'Gesamt' %}
        <div class="score-card">
            <div class="score-label">{{ cat }}</div>
            <div class="score-value {{ score_color_class(score) }}">{{ "%.0f"|format(score) }}</div>
            <div class="score-bar"><div class="score-bar-fill {{ bar_color_class(score) }}" style="width:{{ score }}%"></div></div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ── Zusammenfassung ── #}
    {% set findings = report.all_findings %}
    {% if findings %}
    <h2>Zusammenfassung</h2>
    <div class="summary">
        {% for sev, items in report.findings_by_severity.items() %}
        <div class="summary-badge badge-{{ sev.value|lower }}">
            {{ items|length }} {{ sev.value }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ── Findings nach Kategorie ── #}
    {% set categories_seen = [] %}
    {% for result in report.results if result.findings %}
    {% if result.kategorie not in categories_seen %}
    {% if categories_seen.append(result.kategorie) %}{% endif %}
    <div class="section">
        <h2>{{ result.kategorie }}</h2>
        {% for r in report.results if r.kategorie == result.kategorie %}
        {% for f in r.findings %}
        <div class="finding finding-{{ f.severity.value|lower }}">
            <div class="finding-header">
                <span class="severity-tag tag-{{ f.severity.value|lower }}">{{ f.severity.value }}</span>
                <span class="finding-title">{{ f.titel }}</span>
            </div>
            <div class="finding-desc">{{ f.beschreibung }}</div>
            {% if f.beweis %}
            <div class="finding-evidence">{{ f.beweis }}</div>
            {% endif %}
            {% if f.empfehlung %}
            <div class="finding-recommendation">→ {{ f.empfehlung }}</div>
            {% endif %}
        </div>
        {% endfor %}
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}

    {# ── Scanner-Fehler ── #}
    {% set errors = report.results|selectattr('success', 'false')|list %}
    {% if errors %}
    <div class="section">
        <h2>Scanner-Fehler</h2>
        {% for r in errors %}
        <div class="finding finding-mittel">
            <div class="finding-header">
                <span class="severity-tag tag-mittel">FEHLER</span>
                <span class="finding-title">{{ r.scanner_name }}</span>
            </div>
            <div class="finding-desc">{{ r.error }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ── Footer ── #}
    <div class="footer">
        Generiert mit mp-web-audit v0.1.0 | {{ report.zeitstempel.strftime('%d.%m.%Y %H:%M') }}
    </div>

</div>
</body>
</html>
