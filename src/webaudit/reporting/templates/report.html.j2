<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web-Audit Report – {{ report.target_url }}</title>
    <style>{{ css }}</style>
</head>
<body>
<div class="container">

    {# ── Header ── #}
    <div class="header">
        <h1>Web-Audit Report</h1>
        <div class="meta">
            Ziel: <strong>{{ report.target_url }}</strong>{% if report.target_ip %} <span style="color:#888">({{ report.target_ip }})</span>{% endif %}<br>
            Zeitpunkt: {{ report.zeitstempel.strftime('%d.%m.%Y %H:%M:%S') }}<br>
            Dauer: {{ "%.1f"|format(report.dauer) }}s
            {% if report.autorisierung %}
            <br>Autorisierung bestaetigt: {{ report.autorisierung.zeitstempel.strftime('%d.%m.%Y %H:%M:%S') }}
            {% endif %}
        </div>
    </div>

    {# ── Inhaltsverzeichnis ── #}
    <nav class="toc">
        <h2>Inhalt</h2>
        <ul>
            {% if report.scores %}<li><a href="#scores">Bewertung</a></li>{% endif %}
            <li><a href="#summary">Zusammenfassung</a></li>
            {% set toc_categories = [] %}
            {% for result in report.results if result.findings %}
            {% if result.kategorie not in toc_categories %}
            {% if toc_categories.append(result.kategorie) %}{% endif %}
            <li><a href="#cat-{{ result.kategorie|lower|replace(' ', '-') }}">{{ result.kategorie }}</a></li>
            {% endif %}
            {% endfor %}
        </ul>
    </nav>

    {# ── Scores ── #}
    {% if report.scores %}
    <h2 id="scores">Bewertung</h2>
    <div class="scores">
        {% if 'Gesamt' in report.scores %}
        {% set gs = report.scores['Gesamt'] %}
        <div class="score-card gesamt">
            <div class="score-label">Gesamt-Score</div>
            <div class="score-value {{ score_color_class(gs) }}">{{ "%.0f"|format(gs) }}</div>
            <div class="score-bar"><div class="score-bar-fill {{ bar_color_class(gs) }}" style="width:{{ gs }}%"></div></div>
        </div>
        {% endif %}
        {% for cat, score in report.scores.items() if cat != 'Gesamt' %}
        <div class="score-card">
            <div class="score-label">{{ cat }}</div>
            <div class="score-value {{ score_color_class(score) }}">{{ "%.0f"|format(score) }}</div>
            <div class="score-bar"><div class="score-bar-fill {{ bar_color_class(score) }}" style="width:{{ score }}%"></div></div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ── Zusammenfassung ── #}
    {% set findings = report.all_findings %}
    {% if findings %}
    <h2 id="summary">Zusammenfassung</h2>
    <div class="summary">
        {% for sev, items in report.findings_by_severity.items() %}
        <div class="summary-badge badge-{{ sev.value|lower }}">
            {{ items|length }} {{ sev.value }}
        </div>
        {% endfor %}
    </div>

    {# ── Executive Summary ── #}
    {% set kritisch_count = report.findings_by_severity.get(severity_enum.KRITISCH, [])|length %}
    {% set hoch_count = report.findings_by_severity.get(severity_enum.HOCH, [])|length %}
    {% set mittel_count = report.findings_by_severity.get(severity_enum.MITTEL, [])|length %}
    {% set gesamt_score = report.scores.get('Gesamt', 0) %}
    <div class="executive-summary">
        <h3>Executive Summary</h3>
        <p>
        {% if kritisch_count > 0 %}
            <strong class="bewertung-kritisch">Kritischer Handlungsbedarf:</strong>
            Es wurden {{ kritisch_count }} kritische und {{ hoch_count }} schwerwiegende Schwachstellen identifiziert.
            Sofortige Massnahmen sind erforderlich.
        {% elif hoch_count > 0 %}
            <strong class="bewertung-hoch">Handlungsbedarf:</strong>
            Es wurden {{ hoch_count }} schwerwiegende Schwachstellen identifiziert.
            Zeitnahe Behebung wird empfohlen.
        {% elif mittel_count > 0 %}
            <strong class="bewertung-mittel">Verbesserungswuerdig:</strong>
            Es wurden {{ mittel_count }} mittelschwere Auffaelligkeiten identifiziert.
        {% else %}
            <strong class="bewertung-gut">Guter Zustand:</strong>
            Keine schwerwiegenden Probleme erkannt.
        {% endif %}
        </p>
        {% if kritisch_count > 0 or hoch_count > 0 %}
        <div class="sofortmassnahmen">
            <strong>Empfohlene Sofortmassnahmen:</strong>
            <ul>
            {% for f in report.all_findings[:5] %}
                {% if f.severity.value in ['KRITISCH', 'HOCH'] and f.empfehlung %}
                <li>{{ f.empfehlung }}</li>
                {% endif %}
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    {# ── Severity-Verteilung (SVG Chart) ── #}
    <div class="severity-chart">
        <h3>Severity-Verteilung</h3>
        {% set sev_data = [
            ('KRITISCH', report.findings_by_severity.get(severity_enum.KRITISCH, [])|length, '#ef4444'),
            ('HOCH', report.findings_by_severity.get(severity_enum.HOCH, [])|length, '#f97316'),
            ('MITTEL', report.findings_by_severity.get(severity_enum.MITTEL, [])|length, '#eab308'),
            ('NIEDRIG', report.findings_by_severity.get(severity_enum.NIEDRIG, [])|length, '#3b82f6'),
            ('INFO', report.findings_by_severity.get(severity_enum.INFO, [])|length, '#22c55e'),
        ] %}
        {% set max_count = [1] %}
        {% for _, count, _ in sev_data %}{% if count > max_count[0] %}{% if max_count.append(count) %}{% endif %}{% endif %}{% endfor %}
        <svg viewBox="0 0 500 180" class="chart-svg">
            {% for label, count, color in sev_data %}
            {% set y = loop.index0 * 34 + 10 %}
            {% set bar_width = (count / max_count[-1]) * 300 if max_count[-1] > 0 else 0 %}
            <text x="75" y="{{ y + 16 }}" text-anchor="end" fill="#94a3b8" font-size="13">{{ label }}</text>
            <rect x="85" y="{{ y }}" width="{{ bar_width }}" height="22" rx="4" fill="{{ color }}" opacity="0.85"/>
            <text x="{{ 95 + bar_width }}" y="{{ y + 16 }}" fill="#e2e8f0" font-size="13" font-weight="600">{{ count }}</text>
            {% endfor %}
        </svg>
    </div>
    {% endif %}

    {# ── Severity-Filter ── #}
    <div class="filter-bar no-print">
        <span class="filter-label">Filter:</span>
        <button class="filter-btn active" data-severity="all" onclick="filterFindings('all')">Alle</button>
        <button class="filter-btn" data-severity="kritisch" onclick="filterFindings('kritisch')">KRITISCH</button>
        <button class="filter-btn" data-severity="hoch" onclick="filterFindings('hoch')">HOCH</button>
        <button class="filter-btn" data-severity="mittel" onclick="filterFindings('mittel')">MITTEL</button>
        <button class="filter-btn" data-severity="niedrig" onclick="filterFindings('niedrig')">NIEDRIG</button>
        <button class="filter-btn" data-severity="info" onclick="filterFindings('info')">INFO</button>
    </div>

    {# ── Findings nach Kategorie ── #}
    {% set categories_seen = [] %}
    {% for result in report.results if result.findings %}
    {% if result.kategorie not in categories_seen %}
    {% if categories_seen.append(result.kategorie) %}{% endif %}
    <div class="section" id="cat-{{ result.kategorie|lower|replace(' ', '-') }}">
        <h2>{{ result.kategorie }}</h2>
        {% for r in report.results if r.kategorie == result.kategorie %}
        {% for f in r.findings %}
        <div class="finding finding-{{ f.severity.value|lower }}" data-severity="{{ f.severity.value|lower }}">
            <div class="finding-header">
                <span class="severity-tag tag-{{ f.severity.value|lower }}">{{ f.severity.value }}</span>
                <span class="finding-title">{{ f.titel }}</span>
            </div>
            {% if f.cwe_id or f.owasp_category %}
            <div class="finding-refs">
                {% if f.cwe_id %}<span class="ref-badge cwe-badge">{{ f.cwe_id }}</span>{% endif %}
                {% if f.owasp_category %}<span class="ref-badge owasp-badge">{{ f.owasp_category }}</span>{% endif %}
            </div>
            {% endif %}
            <div class="finding-desc">{{ f.beschreibung }}</div>
            {% if f.beweis %}
            <div class="finding-evidence">{{ f.beweis }}</div>
            {% endif %}
            {% if f.empfehlung %}
            <div class="finding-recommendation">→ {{ f.empfehlung }}</div>
            {% endif %}
        </div>
        {% endfor %}
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}

    {# ── Scanner-Fehler ── #}
    {% set errors = report.results|selectattr('success', 'false')|list %}
    {% if errors %}
    <div class="section">
        <h2>Scanner-Fehler</h2>
        {% for r in errors %}
        <div class="finding finding-mittel">
            <div class="finding-header">
                <span class="severity-tag tag-mittel">FEHLER</span>
                <span class="finding-title">{{ r.scanner_name }}</span>
            </div>
            <div class="finding-desc">{{ r.error }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ── Footer ── #}
    <div class="footer">
        Generiert mit mp-web-audit v{{ report.metadata.tool_version if report.metadata else '0.0.1' }} | {{ report.zeitstempel.strftime('%d.%m.%Y %H:%M') }}
    </div>

</div>

<script>
function filterFindings(severity) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-severity="' + severity + '"]').classList.add('active');
    document.querySelectorAll('.finding[data-severity]').forEach(f => {
        f.style.display = (severity === 'all' || f.dataset.severity === severity) ? '' : 'none';
    });
}
</script>
</body>
</html>
